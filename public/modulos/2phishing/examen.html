<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Examen Phishing</title>
  <link rel="stylesheet" href="../../style.css">
</head>
<body>
  <header>
    <div class="logo">NoHaxx</div>
  </header>

  <main class="main-content">
    <section class="modulo">
      <h2>ğŸ“‹ Parte 3: Examen Final Phishing</h2>
      <p>Responde a estas preguntas para completar el mÃ³dulo. Necesitas acertar al menos 2 de 3 para aprobar.</p>

      <div class="pregunta examen" data-correcta="c">
        <p>1. Recibes un correo del â€œdepartamento de ITâ€ pidiÃ©ndote tu contraseÃ±a para una verificaciÃ³n urgente. Â¿QuÃ© haces?</p>
        <button data-respuesta="a">Se la envÃ­as, para evitar problemas</button>
        <button data-respuesta="b">Ignoras el correo pero no haces nada mÃ¡s</button>
        <button data-respuesta="c">Lo reportas y no respondes</button>
      </div>

      <div class="pregunta examen" data-correcta="b">
        <p>2. Â¿QuÃ© detalle tÃ©cnico puede ayudarte a detectar un intento de phishing?</p>
        <button data-respuesta="a">El mensaje viene en formato HTML</button>
        <button data-respuesta="b">El enlace real no coincide con el texto del enlace</button>
        <button data-respuesta="c">El correo contiene imÃ¡genes de buena calidad</button>
      </div>

      <div class="pregunta examen" data-correcta="a">
        <p>3. Â¿CuÃ¡l de las siguientes acciones es mÃ¡s segura?</p>
        <button data-respuesta="a">Entrar al sitio escribiendo la URL tÃº mismo</button>
        <button data-respuesta="b">Acceder a travÃ©s del enlace del correo</button>
        <button data-respuesta="c">Preguntar al remitente si el enlace es legÃ­timo</button>
      </div>

      <div class="resultado">
        <p id="puntuacion-examen" style="font-weight:bold; margin-top:20px;"></p>
        <div id="mensaje-final"></div>
      </div>
    </section>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  
  <script src="../../scripts/firebase-config.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const preguntas = document.querySelectorAll('.pregunta.examen');
      const puntuacionTxt = document.getElementById('puntuacion-examen');
      const mensajeFinal = document.getElementById('mensaje-final');
      
      let aciertos = 0;
      let contestadas = 0;
      const total = preguntas.length;

      preguntas.forEach(pregunta => {
        const botones = pregunta.querySelectorAll('button');
        botones.forEach(btn => {
          btn.addEventListener('click', (e) => {
            // Evitar que se responda mÃ¡s de una vez a la misma pregunta
            if(pregunta.classList.contains('contestada')) return;
            pregunta.classList.add('contestada');

            const respuestaUser = e.target.getAttribute('data-respuesta');
            const respuestaCorrecta = pregunta.getAttribute('data-correcta');

            // Feedback visual inmediato
            if (respuestaUser === respuestaCorrecta) {
              e.target.style.backgroundColor = '#d4edda'; // Verde claro
              e.target.style.borderColor = '#c3e6cb';
              aciertos++;
            } else {
              e.target.style.backgroundColor = '#f8d7da'; // Rojo claro
              e.target.style.borderColor = '#f5c6cb';
            }
            
            contestadas++;

            // Si se han contestado todas, calculamos nota final
            if (contestadas === total) {
              finalizarExamen(aciertos);
            }
          });
        });
      });

      function finalizarExamen(nota) {
        puntuacionTxt.textContent = `Tu puntuaciÃ³n: ${nota}/${total}`;
        
        // Criterio: Necesitas al menos 2 de 3 para aprobar
        const aprobado = nota >= 2; 

        if (aprobado) {
           mensajeFinal.innerHTML = "<h3 style='color:green'>Â¡Aprobado! âœ…</h3><p>Guardando tu progreso...</p>";
           guardarNota(10); // Asignamos 10 puntos si aprueba
        } else {
           mensajeFinal.innerHTML = "<h3 style='color:red'>Has suspendido âŒ</h3><p>Repasa la teorÃ­a e intÃ©ntalo de nuevo.</p><button onclick='location.reload()' class='boton'>Reintentar</button>";
        }
      }

      function guardarNota(puntos) {
        const auth = firebase.auth();
        const db = firebase.firestore();

        auth.onAuthStateChanged(user => {
          if (user) {
            // Guardamos en la colecciÃ³n 'userScores' bajo el campo 'phishing'
            db.collection('userScores').doc(user.uid).set({
              scores: { phishing: puntos }
            }, { merge: true }).then(() => {
               // BotÃ³n para volver al menÃº de mÃ³dulos (donde Ransomware ya deberÃ­a estar desbloqueado)
               mensajeFinal.innerHTML += "<br><a href='../../modulos.html' class='boton' style='margin-top:10px'>Volver a MÃ³dulos</a>";
            }).catch(err => {
               console.error(err);
               mensajeFinal.textContent = "Error al guardar: " + err.message;
            });
          } else {
             mensajeFinal.textContent = "Error: No se detectÃ³ sesiÃ³n de usuario.";
          }
        });
      }
    });
  </script>
</body>
</html>